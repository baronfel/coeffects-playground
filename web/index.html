<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width" />
  <title>Coeffects</title>
  <script src="//code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha256-KXn5puMvxCw+dAYznun+drMdG1IFl3agK0p/pqT9KAo= sha512-2e8qq0ETcfWRI4HJBzQiA3UoyFk6tbNyG+qSaIBZLyW9Xf3sWZHN/lxe9fTh1U45DpPf07yj94KsUHHWe4Yk1A==" crossorigin="anonymous"></script>
  <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-7s5uDGW3AHqw6xtJmNNtr+OBRJUlgkNJEo78P4b0yRw= sha512-nNo+yCHEyn0smMxSswnf/OnX6/KwJuZTlNZBjauKhTK0c+zT+q5JOCx0UFhXQ6rJR9jg6Es8gPuD2uZcYDLqSw==" crossorigin="anonymous">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
  <script src='//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({ TeX: { extensions: ["color.js"] }});
  </script>  
  <link rel="stylesheet" href="style.css" />
  <script src="interactive.js" type="text/javascript"></script>
  <script src="tips.js" type="text/javascript"></script>
  <script src="script.js" type="text/javascript"></script>
</head>
<body>
  <div id="header">
  <div class="container">
    <h1>Coeffects: <em>Context-aware programming languages</em></h1>
  </div>
  </div>
  <nav class="navbar" data-spy="affix" data-offset-top="100">
    <div class="container">
      <div class="navbar-header">
       <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#nb" aria-expanded="false">
         <span class="sr-only">Toggle navigation</span>
         <span class="icon-bar"></span>
         <span class="icon-bar"></span>
         <span class="icon-bar"></span>
       </button>
      </div>
      <div class="collapse navbar-collapse" id="nb">
       <ul class="nav navbar-nav">
         <li><a href="#">Home</a></li>
         <li><a href="#">About</a></li>
         <li><a href="#">Demos</a></li>
       </ul>
       <ul class="nav navbar-nav navbar-right ia-ui-menu">
         <li class="ia-choice" data-ia-key="ch1" data-ia-ui-kind="box" data-ia-show="" data-ia-hide="intro-motivation intro-theory langs-info langs-impl-1 langs-impl-2 langs-impl-3"><a href="#">Short</a></li>
         <li class="ia-choice" data-ia-key="ch2" data-ia-ui-kind="box" data-ia-show="intro-motivation langs-impl-1 langs-impl-2" data-ia-hide="intro-theory langs-info langs-impl-3"><a href="#">Practice</a></li>
         <li class="ia-choice" data-ia-key="ch3" data-ia-ui-kind="box" data-ia-show="intro-theory langs-info langs-impl-3" data-ia-hide="intro-motivation langs-impl-1 langs-impl-2"><a href="#">Theory</a></li>
         <li class="ia-choice" data-ia-key="ch4" data-ia-ui-kind="box" data-ia-show="intro-motivation intro-theory langs-info langs-impl-1 langs-impl-2 langs-impl-3" data-ia-hide=""><a href="#">All</a></li>
       </ul>
      </div>
    </div>
  </nav>      
  
  <div class="below-nav outline">
  <div class="container">
  <div class="col-sm-7">
    
    >>>>
    
    Coeffects are [Tomas Petricek's](http://tomasp.net/academic) PhD research project.
    They are a programming language abstraction for understanding how programs access the 
    _context_ or _environment_ in which they execute.
    
    The context may be resources on your mobile phone (battery, GPS location or a network printer), 
    IoT devices in a physical neighborhood or historical stock prices. By understanding the neighborhood
    or history, a _context-aware_ programming language can catch bugs earlier and run more efficiently.
    
    This page is an interactive tutorial that shows a prototype implementation of
    coeffects in a browser. You can play with two simple context-aware languages, see how the 
    type checking works and how context-aware programs run.

    This page is also an experiment in presenting programming language research. It is a live
    environment where you can play with the theory using the power of new media, rather than 
    staring at a dead pieces of wood (although we [have those too](about.html)).
    
    <<<<
    
  </div>
  <div class="col-sm-5">
    <p>We hide some details by default to keep the tutorial shorter, but you can get them back if you want!
    </p>
  
    <div class="row ia-ui-boxes">
      <div class="col-md-6">
        <div class="ia-ui-box ia-choice" data-ia-key="ch1" data-ia-ui-kind="box" data-ia-show="" data-ia-hide="intro-motivation intro-theory langs-info">
          <p><i class="fa fa-thumbs-up"></i><strong>Short is good!</strong> You can always come back.</p></div>
      </div>
      <div class="col-md-6">
        <div class="ia-ui-box ia-choice" data-ia-key="ch2" data-ia-ui-kind="box" data-ia-show="intro-motivation" data-ia-hide="intro-theory langs-info">
          <p><i class="fa fa-industry"></i><strong>I'm practical!</strong> Show me more examples.</p></div>
      </div>
    </div>
    <div class="row ia-ui-boxes">
      <div class="col-md-6">
        <div class="ia-ui-box ia-choice" data-ia-key="ch3" data-ia-ui-kind="box" data-ia-show="intro-theory langs-info" data-ia-hide="intro-motivation">
          <p><i class="fa fa-university"></i><strong>Love theory!</strong> Give me all the equations.</p></div>
      </div>
      <div class="col-md-6">
        <div class="ia-ui-box ia-choice" data-ia-key="ch4" data-ia-ui-kind="box" data-ia-show="intro-motivation intro-theory langs-info" data-ia-hide="">
          <p><i class="fa fa-search"></i><strong>Show me all!</strong> Time is not an issue.</p></div>
      </div>
    </div>

  </div>
  </div>
  </div>
  
  <div style="display:none">
    \[
      \definecolor{leff}{RGB}{255,107,102}
      \definecolor{lcoeff}{RGB}{78,206,88}
      \definecolor{ltyp}{RGB}{255,202,79}
      \definecolor{lkvd}{RGB}{127,165,255}
      
      \definecolor{eff}{RGB}{177,35,43}
      \definecolor{coeff}{RGB}{35,177,53}
      \definecolor{typ}{RGB}{177,93,43}
      \definecolor{expr}{RGB}{0,0,0}
      \definecolor{kvd}{RGB}{0,45,177}
      \definecolor{num}{RGB}{43,177,93}      
    \]
  </div>
  <div class="body container">
    <div class="row">
    <div class="hidden-sm col-md-1"></div>
    <div class="col-sm-8 col-md-7 rside">
      <h2>
        <span>What problem are coeffects solving?</span><br class="hidden-sm hidden-xs hidden-md" />
        <span class="ia-choice ia-ui-circle" data-ia-undoable="true" data-ia-key="ch5" data-ia-ui-kind="circle" data-ia-show="intro-motivation" data-ia-hide=""
          title="Click here to see additional &#10;practical motivation for coeffects">
          <i class="fa fa-industry"></i>
        </span>
        <span class="ia-choice ia-ui-circle" data-ia-undoable="true" data-ia-key="ch6" data-ia-ui-kind="circle" data-ia-show="intro-theory" data-ia-hide=""
          title="Click here to learn more about &#10;the theory and related work">
          <i class="fa fa-university"></i>
        </span>
      </h2>

      >>>>
      Programming languages evolve to reflect the changes in the computing ecosystem.
      The next big challenge for programming language designers is building languages that 
      understand the _context in which programs run_.
        
      This challenge is not easy to see. We are so used to work with context using the current
      cumbersome methods that we do not even _see that there is an issue_. We also do not
      realize that many programming features related to _context_ can be caputred by the
      a simple _unified abstraction_. This is what coeffects do!

      <div class="ia-choice ia-ui-bar-left" data-ia-undoable="true" data-ia-key="ch5" data-ia-ui-kind="circle" data-ia-ui-prop="border-color" data-ia-show="intro-motivation" data-ia-hide="">
      
      What are some examples of context-aware computations?
      
       - In cross-platform code, the functions available on different platforms are a
         context. You can use `#if`. If you get this wrong, your code won't even compile!     
         
       - In the [Game of Life](https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life) or 
         [weather simulations](https://en.wikipedia.org/wiki/Stencil_code), each cell in a grid
         accesses neighboring cells. But do you know how many neighbors it needs?

      </div>
      <<<<      
    </div>
  </div>
  <div class="row ia" data-ia-key="intro-motivation" data-ia-mode="long">
    <div class="col-sm-6">
      >>>>
          [hide]
          type Cache() =
            member x.Contains(key:string) = false
            member x.Get(key:string) = ""
            member x.Set(key:string, value:string) = ()
            
          open System
          let cache = new Cache()
    
      ### Cross-platformn caching

      Say you need a function that caches values in an in-memory dictionary, or using
      a local file system when it is available. Using `#if`, you can write:

          let readFromCache key f =
          
            // Read value from memory or disk
            if cache.Contains(key) then 
              cache.Get(key)
          #if LOCAL_FILE_SYSTEM
            elif File.Exists(key) then 
              File.ReadAllText(key)              
          #endif
          
            // Calculate and cache the value
            else
              let result = f()
              cache.Set(key, result)
          #if LOCAL_FILE_SYSTEM
              File.WriteAllText(key, result)
          #endif    
              result

      
      You could refactor the code to make it less ugly, but the issue will not go away.
      As you need to target more and more platforms, the combinations of `#if` flags grow
      exponentially and it is hard to know that all configurations even compile.
      
      Ideally, the programming language would understand which functions need what capabilities
      and it would automatically check on which platforms can your code run.      
      <<<<
    </div>
    <div class="col-sm-6">
      
      >>>>
          [hide]
          let input = [| 0 |]
          let output = [| 0 |]
          let cursor = 0
          
      ### Stencil computations
      
      In stencil computations, we calcualte value for each element of a grid or mesh based on its
      neighborhood. This is useful in simulations in fluid dynamics or weather modelling. 
      
      A simple example is Conway's Game of Life or other cellural automata. The following example
      implements the [rule 110](https://en.wikipedia.org/wiki/Rule_110) (`arr.[x]` accesses x<sup>th</sup>
      element of the array and `cursor` is the current position):

          let sum = input.[cursor-1] + 
            input.[cursor] + input.[cursor+1] 
            
          if sum = 2 || (sum = 1 && 
              input.[cursor-1] = 0)
            then output.[cursor] <- 1 
            else output.[cursor] <- 0 

      <table id='rule110' style="margin:-10px 20px 5px 20px; overflow:hidden;"></table>
      <div style="text-align:right;"><button id='rule110btn' class="btn" style="width:60px;margin:0px 20px 5px 0px">Run</button></div>
      
      This automata looks at one item on the left and one item on the right. Knowing this is important
      for correctly handling border conditions. If the compiler knew the access pattern, it could
      check this and it could also pre-allocate the necessary space and produce more efficient code,
      especially when compiling for a GPU.
      <<<<
      
    </div>
  </div>
  <div class="row new-section">
    <div class="col-md-7">
      <div class="ia-slides" id="judgement-slides">
      >>>>
      <div class="slide">
      
      ### Simple type systems
      
      To understand effects and coeffects, let's look at how their type systems work. 
      In langauges like F#, the following holds:
      
      $$$
      x:{\color{ltyp} \text{int}},~ y:{\color{ltyp} \text{int}} \vdash x+y : {\color{ltyp} \text{int}}
      
      This says that in a _context_ with variablex $x$ and $y$ of type $\color{ltyp}\text{int}$, the
      type of expression $x+y$ is also $\color{ltyp}\text{int}$. The context on the left of $\vdash$
      is important! If the variables $x$ and $y$ had incompatible types, this would not be well-typed!
            
      </div><div class="slide">
      
      ### Effect systems
      
      The type of expressions with side-effect is $\color{ltyp}\text{unit}$, which does not tell 
      us very much! Effect systems add one more component:
      
      $$$
      hello : {\color{ltyp} \text{string}} \vdash {\color{lkvd} \text{print}}~hello : {\color{ltyp} \text{unit}} {\scriptsize \;\&\;} {\color{leff} \{ \text{io} \} }
      
      Effect systems understand built-in functions like ${\color{lkvd} \text{print}}$ and they infer
      not just the type of an expression, but also an _effect_. Here ${\color{leff} \{ \text{io} \} }$
      means that the expression requires I/O access but not, for example, direct access to mutable memory.
      
      </div><div class="slide">
      
      ### Coeffect systems
      
      Coeffects add an annotation to the _context_ of an expression. For example, checking whether we
      missed a deadline returns $\color{ltyp} \text{bool}$ and requires a set of resources
      $\color{lcoeff} \{ \text{clock} \}$:
      
      $$$
      deadline : {\color{ltyp} \text{time}} {\scriptsize \;@\;} {\color{lcoeff} \{ \text{clock} \} } 
        \vdash {\color{lkvd} \text{now}} \geq deadline : {\color{ltyp} \text{bool}}
      
      Coeffects can do more though. We can add requirements to the whole context (as here), but 
      also to individual variables. We will do this later for checking dataflow computations.
      
      </div><div class="slide">
      
      ### Type systems side-by-side
      
      <table>
      <tr><td style="padding-right:20px">
        
      $$$
      \Gamma \vdash e : {\color{ltyp} \tau}

      </td><td>
        
      In standard type systems, we say that given variables in $\Gamma$, 
      an expression $e$ has a type ${\color{ltyp} \tau}$:
      
      </td></tr><tr><td style="padding-right:20px">
      
      $$$
      \Gamma \vdash e : {\color{ltyp} \tau} {\scriptsize \;\&\;} {\color{leff} r}
      
      </td><td>
      
      Effect systems add annotation to the result. Given variables in $\Gamma$, 
      an expression $e$ has a type ${\color{ltyp} \tau}$ and an _effect_ ${\color{leff} r}$:
      
      </td></tr><tr><td style="padding-right:20px">
    
      $$$
      \Gamma {\scriptsize \;@\;} {\color{lcoeff} r} \vdash e : {\color{ltyp} \tau}
      
      </td><td>
    
      Coeffect systems say more about the context. Given a variables in $\Gamma$
      and additioonal context ${\color{lcoeff} r}$ an expression $e$ has a type ${\color{ltyp} \tau}$:
      
      </td></tr></table>      
      </div>
      <<<<
      </div>  
    </div>
    <div class="col-md-5">
      >>>>
      <div class="ia-choice ia-ui-bar-right" data-ia-undoable="true" data-ia-key="ch6" data-ia-ui-kind="circle" data-ia-ui-prop="border-color" data-ia-show="intro-theory" data-ia-hide="">

      _Coeffects_ are the <abbr title="In the category-theoretial sense, but there are interesting subtle issues!">dual</abbr> 
      of _effects_. Effects represent what your program _does to the world_ while coeffects track 
      what your program _requires from the world_. 
      
      Writing to a console is an I/O effect. You modify the world. If your program reads the 
      current time, it is a coeffect. The environment has to provide a clock. 
      
      One difference between effects and coeffects is that coeffects can be satisfied in multiple 
      different ways. If the device visitng your client/server application does not have clock, 
      the coeffect can use clock available from the server.
      
      You can see the duality of effects and coeffects when you look at their _type systems_, but
      it also affects the _semantics_. That is, how context-aware programs run.
      
      </div>
      <<<<
    </div>
  </div>
  
  <div class="row ia" data-ia-key="intro-theory" data-ia-mode="long">
    >>>>    
    <div class="col-sm-6 col-md-4">
      
    ### Lambda abstraction
      
    In effect systems, the effects of function body are always <abbr title="Ross Tate (2013) calls 
    this producer effect systems.">delayed</abbr>. A printing inside function body will happen when the 
    function is executed. Coeffects are different. 
    
    Say we have a function that requires a clock. We
    construct it on the server and then send it to the client. The clock can come from the declaration
    side (server) or from the call side (client). Scroll to [coeffect type systems](#typesystem) 
    for the details.
  
    </div><div class="col-sm-6 col-md-4">
      
    ### Structural coeffects
    
    Coeffects can be associated with the whole context, but they can also talk about 
    _individual variables_. For example, we can track whether a variable is used (live) 
    or not (dead):
    
    $$$
    x : {\color{typ} \text{int}}, y : {\color{typ} \text{int}} {\scriptsize \;@\;} 
      {\color{coeff} \langle \sf L, \sf D \rangle } 
      \vdash x : {\color{typ} \text{int}}
    
    Here, the coeffect is a _vector_ of annotations and we see the $x$ is live but 
    $y$ is dead. The compiler can then eliminate dead variables!

    </div><div class="col-sm-12 col-md-4">
      
    ### Comonadic semantics
    
    Effectful computations can be <abbr title="This famous result is due to Moggi (1991)">modelled using monads</abbr>.
    A function $\tau_1 \rightarrow \tau_2$ with side effects becomes $\tau_1 \rightarrow {\color{eff} M}\tau_2$ 
    where the monad ${\color{eff} M}$ tracks the additional effects as part of the result.
    
    Context-aware computations can be similarly <abbr title="This has first been discovered by Uustalu and 
      Vene (2008)">modelled using comonads</abbr>. A function that requires additional context becomes
    ${\color{coeff} C} \tau_1 \rightarrow \tau_2$ where the comonad ${\color{coeff} C}$ captures the
    additional context.
    
    </div>
    <<<<
  </div>  
  
  <div class="row new-section">
    <div class="hidden-sm col-md-3"></div>
    <div class="col-sm-12 col-md-9 lside">  
    <h2>
      <span>Two coeffect languages</span><br class="hidden-sm hidden-xs hidden-md" />
      <span class="ia-choice ia-ui-circle" data-ia-undoable="true" data-ia-key="ch7" data-ia-ui-kind="circle" data-ia-show="langs-info" data-ia-hide=""
        title="Click here to learn more about &#10;how the coeffect playground works">
        <i class="fa fa-search"></i>
      </span>
    </h2>
    >>>>
    
    <div class="row"><div class="col-sm-6">      
    <h3 style="margin-top:0px">Implicit parameters</h3>
    
    Here, you can play with two simple coeffect languages. A language with 
    <abbr title="This is inspired by Haskell's implicit parameters introduced by Lewis et al. (2000)">implicit 
    parameters</abbr> shows how coeffects track additional contextual information such as
    available resources (GPS, network printer) or available device features (file system, network). 
    In our small demo, resources are written as `?size`.
    
    </div><div class="col-sm-6">
    <h3 style="margin-top:0px">Dataflow language</h3>
    
    The second demo is a simple 
    <abbr title="The demo is inspired by the synchronous dataflow language Lustre introduced by Halbwachs et al. (1991)">
    dataflow language</abbr> where all variables represent _streams_ of values
    and you can access previous value using the `prev` keyword. For example `(x + prev x) / 2`
    calculates the average over the current and previous value. Here, coeffects track how many
    past values you need.
          
    </div></div>
    <div class="ia-choice ia-ui-bar-right" data-ia-undoable="true" data-ia-key="ch7" data-ia-ui-kind="circle" data-ia-ui-prop="border-color" data-ia-show="langs-info" data-ia-hide="">
    <div class="row callout" id="playground-callout">
    <div class="col-sm-12"><h3 style="margin:5px 0px 15px 15px;">How does the coeffect playground work?</h3></div>
    <div class="col-sm-4" style="padding-left:30px">
    <i class="fa fa-check-circle" style="color:#FB8072"></i> 
    
    **You choose a snippet. Coeffect system checks it.**
    
    <p class="ia" data-ia-key="langs-info" data-ia-mode="long">
    The system infers the names of the required implicit parameters
    or the required number of past values in the input streams.</p>
    
    </div><div class="col-sm-4" style="padding-left:30px">
    <i class="fa fa-arrow-circle-right" style="color:#80B1D3"></i> 
 
    **Behind the scenes, the snippet is <abbr title="Translated into a plain language.">desugared</abbr>.**
    
    <p class="ia" data-ia-key="langs-info" data-ia-mode="long">
    In the translated code, implicit parameters are passed around as 
    dictionaries and streams become lists of values.</p>
    
    </div><div class="col-sm-4" style="padding-left:30px">      
    <i class="fa fa-play-circle" style="color:#FDB462"></i> 

    **Enter inputs and run the code. It cannot fail!**
    
    <p class="ia" data-ia-key="langs-info" data-ia-mode="long">
    The coeffect type system guarantees that program accesses only the values that
    it asks for and so the program runs correctly!</p>
    
    </div></div></div>    
    <<<<    
    </div>
  </div>
  

  <div class="row new-section">
    <div class="col-md-6"></div>
    <div class="col-md-6">
      <h2>Implicit parameters
        <span style="margin-left:30px;position:relative;top:-5px">
          <span class="ia-choice ia-ui-circle" data-ia-undoable="true" data-ia-key="langs-syntax-1" data-ia-ui-kind="circle" data-ia-show="langs-syntax-1" data-ia-hide=""
            title="Click here to expand &#10;documentation on syntax">
            <i class="fa fa-search"></i>
          </span>
          <span class="ia-choice ia-ui-circle" data-ia-undoable="true" data-ia-key="langs-impl-1" data-ia-ui-kind="circle" data-ia-show="langs-impl-1" data-ia-hide=""
            title="Click here for more detailed &#10;version of the sample explanations">
            <i class="fa fa-industry"></i>
          </span>
          <span class="ia-choice ia-ui-circle" data-ia-undoable="true" data-ia-key="langs-impl-2" data-ia-ui-kind="circle" data-ia-show="langs-impl-2" data-ia-hide=""
            title="Click here for more detailed &#10;version of the sample explanations">
            <i class="fa fa-industry"></i>
          </span>      
          <span class="ia-choice ia-ui-circle" data-ia-undoable="true" data-ia-key="langs-impl-3" data-ia-ui-kind="circle" data-ia-show="langs-impl-3" data-ia-hide=""
            title="Click here for more detailed &#10;version of the sample explanations">
            <i class="fa fa-institution"></i>
          </span>      
        </span>      
      </h2>
    </div>
  </div>
  <div class="row coeff-demo" data-coeff-mode="flat" data-coeff-kind="implicit" id="impl1">
    <div class="col-md-6">
      <div class="callout coeffect-playground" style="padding:30px;margin:0px 10px 30px 0px;">
        <p>Choose a sample from the tutorial or write your own snippet using 
          <code>?param</code> to access an implicit parameter value!</p>

        <textarea class="form-control" id="impl1-input">?fst + ?snd</textarea>
        <button class="btn btn-success" id="impl1-btn"><i class="fa fa-check"></i>Check snippet</button>
        <script>$(function() { $("#impl1-btn").trigger("click"); });</script>
        
        <p id="impl1-error" style="clear:both;"></p>
        <div id="impl1-no-error">
          <p style="clear:both;">The program is well-typed. The type system reports the following 
            type and coeffect information:</p>
          
          <p id="impl1-judgement" data-tex-color-prefix="l"></p>
          <p id="impl1-judgement-temp" style="display:none"></p>
          
          <p id="impl1-playground-no-ui">The context of the expression requires no implicit parameters. You can just run it.</p>
          <p id="impl1-playground-ui">The expression requires some implicit parameter values. You can set their values here:</p>
          <div id="impl1-playground">
          </div>
        </div>
        <div style="clear:both"></div>
      </div>
      >>>>
      <div class="ia-choice ia-ui-bar-left" data-ia-undoable="true" data-ia-key="langs-syntax-1" 
        data-ia-ui-kind="circle" data-ia-ui-prop="border-color" data-ia-show="langs-syntax-1" data-ia-hide="">
      
      Supported syntax in the coeffect language includes numbers and operators, variables and
      implicit parameters, let binding, function values and application.
      
      </div>
      <div class="ia" data-ia-key="langs-syntax-1" data-ia-mode="long">
            
       - Numbers `42`, variables `foo` and implicit parameters `?foo`
       - Numerical operators `+`, `-`, `*`, `/` and `^`
       - Let binding `let x = e1 in e2` where `in` is required
       - Application `e1 e2` and functions `fun x -> e`
       - For a named function use `let f = fun x -> ...`.
       
      </div>
      <<<<      
    </div>
    <div class="col-md-6" data-coeff-editor="impl1">
      >>>>
      <div class="ia-choice ia-ui-bar-right" data-ia-undoable="true" data-ia-key="langs-impl-1" 
        data-ia-ui-kind="circle" data-ia-ui-prop="border-color" data-ia-show="langs-impl-1" data-ia-hide="">
      
      Implicit parameters are the simplest example of coeffects. In our first langauge, 
      you can use `?foo` to access a value that has to be provided by the environment.
      
      </div>
          
          [lang=coeffects-flat-impl]
          ?fst + ?snd
      
      <div class="ia" data-ia-key="langs-impl-1" data-ia-mode="long">
      
      When you load the snippet in the editor, you will need to enter values for `?fst` and `?snd`
      before you can run the code. This is because the two values are the required _coeffects_ of
      the expression. We use numbers, but the same mechanism would work for resources like GPS 
      sensors or printers.
      
      </div>

      ### Static and dynamic scoping
        
      <div class="ia-choice ia-ui-bar-right" data-ia-undoable="true" data-ia-key="langs-impl-2" 
        data-ia-ui-kind="circle" data-ia-ui-prop="border-color" data-ia-show="langs-impl-2" data-ia-hide="">
      
      When you create a function, it can read parameters that are available in the 
      current scope (this is [lexical scoping](https://en.wikipedia.org/wiki/Scope_(computer_science)#Lexical_scoping)),
      but it can also read parameters that are available when the function is called (this is
      [dynamic scoping](https://en.wikipedia.org/wiki/Scope_(computer_science)#Dynamic_scoping)).

      </div>
      <div class="ia" data-ia-key="langs-impl-2" data-ia-mode="long">

      Dynamic scoping is useful when you want to add a parameter to a function in a deeply
      nested chain of calls. With implicit parameters, you do not have to explicitly pass it 
      around in each function. For example:

      </div>
      
          [lang=coeffects-flat-impl]
          let dyn = 
            (fun snd -> ?fst + snd) in
          let ?fst = 10 in dyn ?other

      <div class="ia" data-ia-key="langs-impl-2" data-ia-mode="long">
      
      The function `dyn` uses a parameter `?fst`. We set the parameter value when we _call_ the 
      function. The coeffect system tracks the required implicit parameters and it won't allow calling the
      function if we do not provide a value. You can see (in a tooltip for `dyn`) that the type of 
      the function is `num -{ ?fst:num }-> num`. 
      
      However, coeffects also support lexical scoping and capture parameters that are already in scope:

      </div>
      
          [lang=coeffects-flat-impl]
          let lex = 
            let ?fst = 10 in
            (fun snd -> ?fst + snd) in
          lex ?other

      <div class="ia" data-ia-key="langs-impl-2" data-ia-mode="long">
  
      The implicit parameter `?fst` is in scope when `lex` is defined and so the function
      does not require any implicit parameters. Its type is `num -> num`. 
      
      This is where coeffects differ from effects and monads! If we were using the Reader monad,
      we would get a function that requires `?fst`. In other words, monads support only 
      dynamic scoping, but not lexical scoping.
      
      </div>
      
      ### Resolving ambiguity
        
      <div class="ia-choice ia-ui-bar-right" data-ia-undoable="true" data-ia-key="langs-impl-3" 
        data-ia-ui-kind="circle" data-ia-ui-prop="border-color" data-ia-show="langs-impl-3" data-ia-hide="">
      
      A fun question is, what happens when the parameter `?fst` is available in both the 
      lexical scope (when defining function) and the dynamic scope (when calling the function).
      Run the code sample to see whether `?fst` becomes 100 or 200!

      </div>
      
          [lang=coeffects-flat-impl]
          let both = 
            let ?fst = 100 in
            (fun trd -> ?fst + ?snd + trd) in
          let ?fst = 200 in both 1

      <div class="ia" data-ia-key="langs-impl-3" data-ia-mode="long">
        
      The type of `both` is `num -{ ?snd:num }-> num`, which suggests that parameters available in 
      the lexical scope are always captured (this is the case of `?fst` here). In other words, 
      the _lambda abstraction_ rule in our type system splits the coeffects of the body so that only 
      requirements that cannot be satisfied from the current lexical scope (when defining the 
      function) are delayed and are required when calling the function.
      
      For more information about how this works, scroll down to the [type system section](#typesystem),
      which shows the typing derivations for these examples.

      </div>      
      <<<<
      
    </div>
  </div>
  <div class="row new-section">
    <div class="col-md-6">
      <h2>Dataflow computations
        <span style="margin-left:30px;position:relative;top:-5px">
          <span class="ia-choice ia-ui-circle" data-ia-undoable="true" data-ia-key="langs-syntax-2" data-ia-ui-kind="circle" data-ia-show="langs-syntax-2" data-ia-hide=""
            title="Click here to expand &#10;documentation on syntax">
            <i class="fa fa-search"></i>
          </span>
          <span class="ia-choice ia-ui-circle" data-ia-undoable="true" data-ia-key="langs-df-1" data-ia-ui-kind="circle" data-ia-show="langs-df-1" data-ia-hide=""
            title="Click here for more detailed &#10;version of the sample explanations">
            <i class="fa fa-industry"></i>
          </span>
          <span class="ia-choice ia-ui-circle" data-ia-undoable="true" data-ia-key="langs-df-2" data-ia-ui-kind="circle" data-ia-show="langs-df-2" data-ia-hide=""
            title="Click here for more detailed &#10;version of the sample explanations">
            <i class="fa fa-industry"></i>
          </span>      
          <span class="ia-choice ia-ui-circle" data-ia-undoable="true" data-ia-key="langs-df-3" data-ia-ui-kind="circle" data-ia-show="langs-df-3" data-ia-hide=""
            title="Click here for more detailed &#10;version of the sample explanations">
            <i class="fa fa-institution"></i>
          </span>      
        </span>      
      </h2>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6" data-coeff-editor="df1">
      >>>>
      <div class="ia-choice ia-ui-bar-left" data-ia-undoable="true" data-ia-key="langs-df-1" 
        data-ia-ui-kind="circle" data-ia-ui-prop="border-color" data-ia-show="langs-df-1" data-ia-hide="">
      
      In dataflow languages, each expression denotes a _stream_ of values. The streams can be low-level
      like hardware signals or high-level such as mouse position in modern reactive programming. In our
      langauge, you can use the `prev` keyword to access the previous value of a stream. Coeffects 
      infer how many past values a function may access.
      
      </div>
            
          [lang=coeffects-structural-df]
          fun n -> (n + prev n) / 2
      
      <div class="ia" data-ia-key="langs-df-1" data-ia-mode="long">
      
      This function calculates the average between the _current_ and the _previous_ value. The
      type of the function is `num -{ 1 }-> num` denoting that it needs one last value. Try
      removing `prev` altogether or looking further into the history using `prev (prev n)` to see 
      how the number of required past values changes!
      
      </div>
      <div class="coeff-demo" data-coeff-editor="df1fl" data-coeff-mode="flat" data-coeff-kind="dataflow" id="df1fl">

      ### Structural and flat coeffects
      
      <div class="ia-choice ia-ui-bar-left" data-ia-undoable="true" data-ia-key="langs-df-2" 
        data-ia-ui-kind="circle" data-ia-ui-prop="border-color" data-ia-show="langs-df-2" data-ia-hide="">
            
      Coeffects can track information in two ways. _Flat_ coeffects track one piece of information 
      for the whole expression while _structural_ coeffects have one piece of information for each
      variable. Implicit parameters are flat, but dataflow coeffects can work in both ways.

      The following snippet is checked using the flat coeffect system. The type of `flat` says
      that we need one past value of both `x` and `y`:
      
      </div>
      <div class="pre-edit" id="switch1">
      <a id="df1fl-btn" style="display:none; right:95px"><i class="fa fa-check-square-o"></i>check</a>
      <a onclick="$('#switch1 pre, #switch1 textarea, #df1fl-btn').toggle()"><i class="fa fa-pencil-square-o"></i> edit</a>
        
          [lang=coeffects-flat-df-autoload]
          let flat x y = x + prev y in
          flat
      
      <div class="prelike">
      <textarea class="prelike" id="df1fl-input" style="height:80px;display:none">let flat x y = x + prev y in
      flat</textarea></div>
      </div>
      <div style="margin-top:-15px">
      <p id="df1fl-judgement" style="margin-right:40px" data-tex-color-prefix=""></p>
      <p id="df1fl-judgement-temp" style="display:none"></p></div>
      <div class="ia" data-ia-key="langs-df-2" data-ia-mode="long">
      
      When checking the body `x + prev y`, the flat system infers that the required number of past
      values is 1. There is just one number for the whole expression, so the system does not capture
      the fact that we're only accessing past value of the variable `y`. Try changing the body to
      `x + y` or to `prev (x + y)` and see how the inferred type changes. Click "edit" and then
      "check" to type-check the code snippet.
      
      </div>
      </div>
      <div class="coeff-demo" data-coeff-editor="df1st" data-coeff-mode="structural" data-coeff-kind="dataflow" id="df1st">
      <div class="ia-choice ia-ui-bar-left" data-ia-undoable="true" data-ia-key="langs-df-2" 
        data-ia-ui-kind="circle" data-ia-ui-prop="border-color" data-ia-show="langs-df-2" data-ia-hide="">

      The following snippet is checked using the structural coeffect system. The type of `struct`
      says that we need one past value of `y` but only the current value of `x`:

      </div>
      <div class="pre-edit" id="switch2">
      <a id="df1st-btn" style="display:none; right:95px"><i class="fa fa-check-square-o"></i>check</a>
      <a onclick="$('#switch2 pre, #switch2 textarea, #df1st-btn').toggle()"><i class="fa fa-pencil-square-o"></i> edit</a>
        
          [lang=coeffects-structural-df-autoload]
          let struct x y = x + prev y in
          struct
      
      <div class="prelike">
      <textarea class="prelike" id="df1st-input" style="height:80px;display:none">let struct x y = x + prev y in
      struct</textarea></div>
      </div>
      <div style="margin-top:-15px">
      <p id="df1st-judgement" style="margin-right:40px" data-tex-color-prefix=""></p>
      <p id="df1st-judgement-temp" style="display:none"></p></div>      
      <div class="ia" data-ia-key="langs-df-2" data-ia-mode="long">
      
      The structural system keeps one annotation for each variable. When checking the body `x + prev y`,
      it infers that we access the current value of `x` and one past value of `y`. This is
      reflected in the type of the function. Try changing the body in the same way as previously
      and see how the type of the function changes!
      
      </div>
      </div>

      ### Something else
      
      That
      
          [lang=coeffects-struct-df]
          let f x y = x + prev y in
          f
          
      <<<<
      <div style="display:none;width:1000px;height:100px;background:red;" id="mf">
        <span style="left:10px;top:10px;display:block;position:relative;width:10px;height:10px;background:yellow" id="mv"></span>
      </div>
      <script src="http://smoothiecharts.org/smoothie.js"></script>
      <canvas width="400" height="100" id="myDiv"></canvas>
      <script>
        var xseries = new TimeSeries();
        var yseries = new TimeSeries();
      
        var handler = function(event) { 
          event.preventDefault();
          var px = event.pageX || event.originalEvent.targetTouches[0].pageX;
          var py = event.pageY || event.originalEvent.targetTouches[0].pageY;
          xseries.append(new Date().getTime(), px - $(this).offset().left);
          yseries.append(new Date().getTime(), py - $(this).offset().top);
        };
        $("#mf").on("touchmove", handler);
        $("#mf").on("mousemove", handler);

        function createTimeline() {
          var chart = new SmoothieChart({ millisPerPixel:5 });
          chart.addTimeSeries(xseries, { strokeStyle: 'rgba(0, 255, 0, 1)', fillStyle: 'rgba(0, 255, 0, 0.2)', lineWidth: 4 });
          chart.addTimeSeries(yseries, { strokeStyle: 'rgba(0, 255, 0, 1)', fillStyle: 'rgba(0, 255, 0, 0.2)', lineWidth: 4 });
          chart.streamTo(document.getElementById("myDiv"), 500);
        }        
        
        //$(function() { createTimeline(); });
      </script>
      
    </div>
    <div class="col-md-6 coeff-demo" data-coeff-mode="structural" data-coeff-kind="dataflow" id="df1">
      <div class="callout coeffect-playground" style="padding:30px;margin:0px 0px 30px 10px;">
        <h3 style="margin:5px 0px 15px 0px;">Implicit parameters playground</h3>
        <p>Choose a sample from the tutorial or write your own snippet using 
          <code>?param</code> to access an implicit parameter value!</p>

        <textarea class="form-control" id="df1-input">fun n -> (n + prev n) / 2</textarea>
        <button class="btn btn-success" id="df1-btn"><i class="fa fa-check"></i>Check snippet</button>
        <script>$(function() { $("#df1-btn").trigger("click"); });</script>
        
        <p id="df1-error" style="clear:both;"></p>
        <div id="df1-no-error">
          <p style="clear:both;">The program is well-typed. The type system reports the following 
            type and coeffect information:</p>
          
          <p id="df1-judgement" data-tex-color-prefix="l"></p>
          <p id="df1-judgement-temp" style="display:none"></p>
          
          <!--
          <p id="df1-playground-no-ui">The context of the expression requires no implicit parameters. You can just run it.</p>
          <p id="df1-playground-ui">The expression requires some implicit parameter values. You can set their values here:</p>
          <div id="df1-playground">
          </div>
        -->
        </div>
        <div style="clear:both"></div>
      </div>
    </div>    
  </div>  
</div>

<div class="outline new-section">
  <div class="body container">
    <h2><a name="typesystem">Type systems</a></h2>
  </div>
</div>
<div class="body container">
        

<div class="row">
<div class="col-sm-2"></div>
<div class="col-sm-8 lside">

Coeffect type system
--------------------

Long scrolling text here... Ovi lispmd idr. Blah goo bar foor foo.  Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo.


Long scrolling text here... Ovi lispmd idr. Blah goo bar foor foo.  Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo.

</div>
</div>

<div class="row">
<div class="col-sm-2"></div>
<div class="col-sm-8">

<div style="font-size:16pt;background:black;margin:20px;color:white;padding:40px">
<div style="width:0;height:0;border-style:solid;border-width:25px 35px 25px 0;border-color: transparent white transparent transparent;">
</div>

$$$
\definecolor{eff}{RGB}{255,107,102}
\definecolor{coeff}{RGB}{78,206,88}
\definecolor{typ}{RGB}{255,202,79}
\definecolor{kvd}{RGB}{127,165,255}

>>>>
<h3>Plan langauge</h3>

$$$
\dfrac
  {\Gamma, x:{\color{ltyp} \tau_1} \vdash e : {\color{ltyp} \tau_2}}
  {\Gamma \vdash {\color{lkvd} \text{fun}}~x \rightarrow e : {\color{ltyp} \tau_1} \rightarrow {\color{ltyp} \tau_2}}

<h3>Effect systems</h3>

$$$
\dfrac
  {\Gamma, x:{\color{ltyp} \tau_1} \vdash e : {\color{ltyp} \tau_2 } {\scriptsize \;\&\;} {\color{leff} r} }
  {\Gamma \vdash {\color{lkvd} \text{fun}}~x \rightarrow e : {\color{ltyp} \tau_1} \xrightarrow{~\color{leff} r~} {\color{ltyp} \tau_2} {\scriptsize \;\&\;} {\color{leff} \emptyset}}

<h3>Coeffect systems</h3>

$$$
\dfrac
  {\Gamma, x:{\color{ltyp} \tau_1} {\scriptsize \;@\;} {\color{lcoeff} r\bullet s} \vdash e : {\color{ltyp} \tau_2 } }
  {\Gamma {\scriptsize \;@\;} {\color{lcoeff} r} \vdash {\color{lkvd} \text{fun}}~x \rightarrow e : {\color{ltyp} \tau_1} \xrightarrow{~\color{lcoeff} s~} {\color{ltyp} \tau_2}}

</div>
<<<<

</div>
</div>
<div class="row">
<div class="col-sm-2"></div>
<div class="col-sm-8">

Long scrolling text here... Ovi lispmd idr. Blah goo bar foor foo.  Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo.


</div>
</div>
<div class="row">
<div class="col-sm-6">

### Implicit parameters

Long scrolling text here... Ovi lispmd idr. Blah goo bar foor foo.  Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo.

</div>
<div class="col-sm-6">

### Dataflow programming

Long scrolling text here... Ovi lispmd idr. Blah goo bar foor foo.  Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo.

</div>
</div>
<div class="row">
<div class="col-sm-2"></div>
<div class="col-sm-8">

Write program in a coeffect language

It gets type checked using coeffect type system
- We know it is correct!

We translate it into plain language
and you can run it!
  
  
Unified abstraction!!!  
  
  
Long scrolling text here... Ovi lispmd idr. Blah goo bar foor foo.  Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo. Ovi lispmd idr. Blah goo bar foor foo.
  
  
</div>
</div>

<<<<
  
</div>
</body>
</html>
